# yaml-language-server: $schema=https://aka.ms/dsc/schemas/v3/bundled/config/document.vscode.json

##########################################################################################################
# NOTE: Run: dsc config set --file .\configurations\dotnet-configuration.dsc.yaml                        #
##########################################################################################################
$schema: https://aka.ms/dsc/schemas/v3/bundled/config/document.json
metadata:
  description: Install tools for .NET development
  winget:
    processor:
      identifier: dscv3
resources:
  - name: Install DotNet SDK 10
    type: Microsoft.WinGet/Package
    properties:
      id: Microsoft.DotNet.SDK.10
      source: winget
  - name: Install Nuget Package Explorer
    type: Microsoft.WinGet/Package
    properties:
      id: "9WZDNCRDMDM3"
      source: msstore
  - name: Install Visual Studio 2026 Enterprise
    type: Microsoft.WinGet/Package
    properties:
      id: Microsoft.VisualStudio.Enterprise
      source: winget
  - name: Install VS Workloads
    type: Microsoft.DSC.Transitional/RunCommandOnSet
    dependsOn:
      - "[resourceId('Microsoft.WinGet/Package', 'Install Visual Studio 2026 Enterprise')]"
    properties:
      executable: pwsh
      arguments:
        - -NoProfile
        - -Command
        - |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) {
            Write-Error "vswhere not found â€” Visual Studio Installer is not installed"
            exit 1
          }
          $vsPath = & $vswhere -latest -products 'Microsoft.VisualStudio.Product.Enterprise' -property installationPath
          if (-not $vsPath) {
            Write-Error "Visual Studio Enterprise installation not found"
            exit 1
          }
          $setup = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\setup.exe"
          $vsconfig = '${WinGetConfigRoot}\.vsconfig'
          Write-Host "Importing .vsconfig into $vsPath"
          & $setup modify --installPath $vsPath --config $vsconfig --quiet --norestart --wait
          if ($LASTEXITCODE -ne 0 -and $LASTEXITCODE -ne 3010) {
            Write-Error "VS Installer exited with code $LASTEXITCODE"
            exit 1
          }
      exitCode: 0
  - name: Install VS Extensions
    type: Microsoft.DSC.Transitional/RunCommandOnSet
    dependsOn:
      - "[resourceId('Microsoft.WinGet/Package', 'Install Visual Studio 2026 Enterprise')]"
    properties:
      executable: pwsh
      arguments:
        - -NoProfile
        - -Command
        - |
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          $jsonContent = Get-Content '${WinGetConfigRoot}\dotnet-configuration-vs-extensions.json' -Raw
          $extensions = (ConvertFrom-Json $jsonContent).extensions
          $vsInstallerService = "C:\Program Files (x86)\Microsoft Visual Studio\Installer\resources\app\ServiceHub\Services\Microsoft.VisualStudio.Setup.Service"
          if (-not (Test-Path $vsInstallerService)) {
            Write-Error "Visual Studio Installer Service not found"
            exit 1
          }
          $marketplaceBase = "https://marketplace.visualstudio.com"
          foreach ($ext in $extensions) {
            $uri = "$marketplaceBase/items?itemName=$($ext.id)"
            $vsixPath = "$env:TEMP\$([guid]::NewGuid()).vsix"
            try {
              $html = Invoke-WebRequest -Uri $uri -UseBasicParsing -SessionVariable session
              $anchor = $html.Links | Where-Object { $_.class -eq 'install-button-container' } | Select-Object -ExpandProperty href
              if (-not $anchor) { Write-Warning "No download link for $($ext.name)"; continue }
              Invoke-WebRequest "$marketplaceBase$anchor" -OutFile $vsixPath -WebSession $session
              Write-Host "Installing $($ext.name)"
              Start-Process -FilePath "$vsInstallerService\VSIXInstaller" -ArgumentList "/q /a $vsixPath" -Wait
              Remove-Item $vsixPath -ErrorAction SilentlyContinue
            } catch {
              Write-Warning "Failed to install $($ext.name): $_"
            }
          }
      exitCode: 0
  - name: Install Visual Studio Code
    type: Microsoft.WinGet/Package
    properties:
      id: Microsoft.VisualStudioCode
      source: winget
  - name: Install VSCode Extensions
    type: Microsoft.DSC.Transitional/RunCommandOnSet
    dependsOn:
      - "[resourceId('Microsoft.WinGet/Package', 'Install Visual Studio Code')]"
    properties:
      executable: pwsh
      arguments:
        - -NoProfile
        - -Command
        - |
          $env:NODE_OPTIONS="--no-deprecation"
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          $jsonContent = Get-Content '${WinGetConfigRoot}\dotnet-configuration-vscode-extensions.json' -Raw
          $extensions = (ConvertFrom-Json $jsonContent).extensions
          $installedExtensions = code --list-extensions
          foreach ($extension in $extensions) {
            if ($installedExtensions -notcontains $extension.name) {
              code --install-extension $extension.name
            }
          }
      exitCode: 0
  - name: Install DotNet Tools
    type: Microsoft.DSC.Transitional/RunCommandOnSet
    dependsOn:
      - "[resourceId('Microsoft.WinGet/Package', 'Install DotNet SDK 10')]"
    properties:
      executable: pwsh
      arguments:
        - -NoProfile
        - -Command
        - |
          $jsonContent = Get-Content '${WinGetConfigRoot}\dotnet-tools-configuration.json' -Raw
          $tools = (ConvertFrom-Json $jsonContent).tools
          $installedTools = dotnet tool list -g | Select-Object -Skip 2 | ForEach-Object { ($_ -split '\s+')[0] }
          foreach ($tool in $tools) {
            $toolId = $tool.id
            $toolVersion = $tool.version
            if (-not ($installedTools -contains $toolId)) {
              $installCommand = "dotnet tool install -g $toolId"
              if ($toolVersion -ne "latest") {
                $installCommand += " --version $toolVersion"
              }
              Invoke-Expression $installCommand
            }
          }
      exitCode: 0
